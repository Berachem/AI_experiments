<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç LangChain BeraMind</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 80px 0;
        }
        .scan-card {
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 15px;
        }
        .feature-icon {
            font-size: 3rem;
            color: #667eea;
        }
        .file-input-wrapper {
            position: relative;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 mb-4">üîç BeraMind</h1>
            <p class="lead mb-5">Analyze your repositories security with AI</p>
            <p class="mb-0">Powered by LangChain + Ollama</p>
        </div>
    </section>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/history">
                    <i class="fas fa-history"></i> Scan History
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card scan-card">
                    <div class="card-body p-5">
                        <h3 class="card-title text-center mb-4">
                            <i class="fas fa-shield-alt text-primary"></i>
                            Start Security Analysis
                        </h3>
                        
                        <form action="/scan" method="POST" id="scanForm" enctype="multipart/form-data">
                            <!-- Scan Type -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Analysis Type:</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="scan_type" id="github" value="github" checked>
                                            <label class="form-check-label" for="github">
                                                <i class="fab fa-github"></i> GitHub Repository
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="scan_type" id="local" value="local">
                                            <label class="form-check-label" for="local">
                                                <i class="fas fa-folder"></i> Local Folder
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Target Input -->
                            <div class="mb-4" id="githubInput">
                                <label for="target" class="form-label fw-bold">Target:</label>
                                <div class="input-group">
                                    <span class="input-group-text" id="target-icon">
                                        <i class="fab fa-github"></i>
                                    </span>
                                    <input type="text" class="form-control" id="target" name="target" 
                                           placeholder="https://github.com/user/repo" required>
                                </div>
                                <div class="form-text" id="target-help">
                                    Enter the GitHub repository URL
                                </div>
                            </div>

                            <!-- Local Folder Input -->
                            <div class="mb-4 d-none" id="localInput">
                                <label for="localPath" class="form-label fw-bold">Local Folder (Absolute path):</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="localPath" name="local_path" 
                                           placeholder="C:\path\to\project">
                                 
                                </div>
                                <input type="file" id="folderInput" webkitdirectory multiple style="display: none;">
                                <!-- <div class="form-text">
                                    Select a folder using the Browse button or enter the path manually
                                </div> -->
                          
                            </div>

                            <!-- Advanced Options -->
                            <div class="mb-4">
                                <button class="btn btn-link text-decoration-none p-0" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#advancedOptions">
                                    <i class="fas fa-cog"></i> Advanced Options
                                </button>
                                
                                <div class="collapse mt-3" id="advancedOptions">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="deepScan" name="deep_scan">
                                                <label class="form-check-label" for="deepScan">
                                                    Deep Analysis
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="includeDeps" name="include_deps" checked>
                                                <label class="form-check-label" for="includeDeps">
                                                    Analyze Dependencies
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-play"></i> Start Analysis
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="row mt-5">
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon mb-3">
                    <i class="fas fa-robot"></i>
                </div>
                <h5>Advanced AI</h5>
                <p class="text-muted">Uses LangChain and Ollama for intelligent analysis</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon mb-3">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h5>OWASP Top 10</h5>
                <p class="text-muted">Detects the most critical vulnerabilities</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon mb-3">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h5>Detailed Reports</h5>
                <p class="text-muted">Complete analysis with recommendations</p>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                    <h5 id="progressTitle">Analysis in progress...</h5>
                    <p class="text-muted mb-4" id="progressSubtitle">This may take a few minutes</p>
                    
                    <!-- Progress Bar -->
                    <div class="progress mb-4" style="height: 8px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             style="width: 0%" id="progressBar"></div>
                    </div>
                    
                    <!-- Current Activity -->
                    <div class="card bg-light">
                        <div class="card-body py-3">
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="spinner-border spinner-border-sm text-secondary me-2" id="activitySpinner"></div>
                                <span id="currentActivity">Initializing scanner...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Steps -->
                    <div class="mt-4">
                        <div class="row text-start">
                            <div class="col-md-6">
                                <h6 class="mb-2">Analysis Steps:</h6>
                                <ul class="list-unstyled small" id="progressSteps">
                                    <li id="step-init"><i class="fas fa-circle text-muted me-2"></i>Initialize scanner</li>
                                    <li id="step-collect"><i class="fas fa-circle text-muted me-2"></i>Collect code files</li>
                                    <li id="step-static"><i class="fas fa-circle text-muted me-2"></i>Static analysis</li>
                                    <li id="step-ai"><i class="fas fa-circle text-muted me-2"></i>AI security analysis</li>
                                    <li id="step-deps"><i class="fas fa-circle text-muted me-2"></i>Dependency check</li>
                                    <li id="step-report"><i class="fas fa-circle text-muted me-2"></i>Generate report</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-2">Statistics:</h6>
                                <div class="small">
                                    <div>Files found: <span id="stat-files" class="fw-bold">-</span></div>
                                    <div>Files analyzed: <span id="stat-analyzed" class="fw-bold">0</span></div>
                                    <div>Vulnerabilities: <span id="stat-vulns" class="fw-bold">0</span></div>
                                    <div>Elapsed time: <span id="stat-time" class="fw-bold">0s</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales pour le suivi
        let progressInterval;
        let timeInterval;
        let startTime;
        let scanId;

        // Switch between GitHub and Local inputs
        document.querySelectorAll('input[name="scan_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const githubInput = document.getElementById('githubInput');
                const localInput = document.getElementById('localInput');
                const targetInput = document.getElementById('target');
                const localPathInput = document.getElementById('localPath');
                
                if (this.value === 'github') {
                    githubInput.classList.remove('d-none');
                    localInput.classList.add('d-none');
                    targetInput.required = true;
                    localPathInput.required = false;
                } else {
                    githubInput.classList.add('d-none');
                    localInput.classList.remove('d-none');
                    targetInput.required = false;
                    localPathInput.required = true;
                }
            });
        });

        // Handle folder selection
        document.getElementById('folderInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const firstFile = e.target.files[0];
                const relativePath = firstFile.webkitRelativePath;
                
                if (relativePath) {
                    const folderName = relativePath.split('/')[0];
                    document.getElementById('localPath').value = folderName;
                } else {
                    alert('Unable to detect folder path. Please enter the path manually.');
                }
            }
        });

        // Enhanced form submission with real-time progress
        document.getElementById('scanForm').addEventListener('submit', function(e) {
            const scanType = document.querySelector('input[name="scan_type"]:checked').value;
            const target = document.getElementById('target').value.trim();
            const localPath = document.getElementById('localPath').value.trim();
            
            // Validation
            if (scanType === 'github') {
                if (!target || !target.includes('github.com')) {
                    e.preventDefault();
                    alert('Please enter a valid GitHub repository URL');
                    return;
                }
            } else if (scanType === 'local') {
                if (!localPath) {
                    e.preventDefault();
                    alert('Please select a local folder or enter the path manually');
                    return;
                }
            }
            
            // Start progress tracking
            startProgressTracking();
        });

        function startProgressTracking() {
            // Show modal
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadingModal.show();
            
            // Initialize
            startTime = Date.now();
            scanId = 'temp_' + Date.now();
            
            // Start time counter
            timeInterval = setInterval(updateElapsedTime, 1000);
            
            // Start progress simulation (will be replaced by real API calls)
            progressInterval = setInterval(simulateProgress, 2000);
        }

        function updateElapsedTime() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('stat-time').textContent = elapsed + 's';
        }

        function simulateProgress() {
            // This simulates the analysis progress
            // In a real implementation, this would call your progress API
            const steps = [
                { id: 'step-init', activity: 'Initializing BeraMind...', progress: 10 },
                { id: 'step-collect', activity: 'Scanning directory for code files...', progress: 25, files: Math.floor(Math.random() * 50) + 10 },
                { id: 'step-static', activity: 'Running static analysis rules...', progress: 45 },
                { id: 'step-ai', activity: 'AI analyzing code for vulnerabilities...', progress: 70, analyzed: Math.floor(Math.random() * 20) + 5 },
                { id: 'step-deps', activity: 'Checking dependencies for known vulnerabilities...', progress: 85 },
                { id: 'step-report', activity: 'Generating security report...', progress: 95, vulns: Math.floor(Math.random() * 10) }
            ];
            
            const currentStep = Math.floor((Date.now() - startTime) / 3000) % steps.length;
            const step = steps[currentStep];
            
            // Update progress bar
            document.getElementById('progressBar').style.width = step.progress + '%';
            
            // Update current activity
            document.getElementById('currentActivity').textContent = step.activity;
            
            // Update step status
            document.querySelectorAll('#progressSteps li').forEach(li => {
                const icon = li.querySelector('i');
                icon.className = 'fas fa-circle text-muted me-2';
            });
            
            // Mark completed steps
            steps.slice(0, currentStep + 1).forEach(s => {
                const stepElement = document.getElementById(s.id);
                if (stepElement) {
                    const icon = stepElement.querySelector('i');
                    icon.className = 'fas fa-check-circle text-success me-2';
                }
            });
            
            // Mark current step
            const currentStepElement = document.getElementById(step.id);
            if (currentStepElement) {
                const icon = currentStepElement.querySelector('i');
                icon.className = 'fas fa-spinner fa-spin text-primary me-2';
            }
            
            // Update statistics
            if (step.files) document.getElementById('stat-files').textContent = step.files;
            if (step.analyzed) document.getElementById('stat-analyzed').textContent = step.analyzed;
            if (step.vulns) document.getElementById('stat-vulns').textContent = step.vulns;
            
            // Complete after all steps
            if (currentStep >= steps.length - 1) {
                setTimeout(() => {
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('currentActivity').textContent = 'Analysis complete! Redirecting...';
                    document.getElementById('activitySpinner').style.display = 'none';
                }, 2000);
            }
        }

        // Clean up intervals when page unloads
        window.addEventListener('beforeunload', function() {
            if (progressInterval) clearInterval(progressInterval);
            if (timeInterval) clearInterval(timeInterval);
        });
    </script>
</body>
</html>
