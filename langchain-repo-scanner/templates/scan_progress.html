<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Progress - BeraMind</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .progress-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .step-item {
            transition: all 0.3s ease;
        }
        .step-item.active {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .step-item.completed {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
        }
        .progress-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">üîç BeraMind</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="progress-container">
            <!-- Header -->
            <div class="text-center mb-4">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                <h2>Security Analysis in Progress</h2>
                <p class="text-muted">Scan ID: {{ scan_id }}</p>
            </div>

            <!-- Progress Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold">Overall Progress</span>
                        <span id="progress-percentage">0%</span>
                    </div>
                    <div class="progress mb-3" style="height: 12px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="main-progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="text-center">
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                            <span id="current-activity">Initializing...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card progress-stats">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="fas fa-chart-bar me-2"></i>Analysis Statistics
                            </h5>
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="h4 mb-1" id="stat-files">-</div>
                                    <small>Files Found</small>
                                </div>
                                <div class="col-3">
                                    <div class="h4 mb-1" id="stat-analyzed">0</div>
                                    <small>Analyzed</small>
                                </div>
                                <div class="col-3">
                                    <div class="h4 mb-1" id="stat-vulns">0</div>
                                    <small>Issues</small>
                                </div>
                                <div class="col-3">
                                    <div class="h4 mb-1" id="stat-time">0s</div>
                                    <small>Elapsed</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    <!-- Error Display -->
    <div class="card border-danger d-none" id="error-card">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>Analysis Error
            </h5>
        </div>
        <div class="card-body">
            <p id="error-message" class="mb-0"></p>
            <div class="mt-3">
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-2"></i>Try Again
                </a>
            </div>
        </div>
    </div>
            <!-- Progress Steps -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>Analysis Steps
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item step-item" id="step-initializing">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-circle text-muted me-3"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">Initialize Scanner</div>
                                    <small class="text-muted">Setting up security analysis engine</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted" id="time-initializing">-</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item step-item" id="step-collecting">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-circle text-muted me-3"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">Collect Code Files</div>
                                    <small class="text-muted">Scanning directory structure for source files</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted" id="time-collecting">-</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item step-item" id="step-static">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-circle text-muted me-3"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">Static Analysis</div>
                                    <small class="text-muted">Running predefined security rules and patterns</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted" id="time-static">-</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item step-item" id="step-ai">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-circle text-muted me-3"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">AI Security Analysis</div>
                                    <small class="text-muted">Deep learning analysis with your Ollama model (LLama, DeepSeek-R1...)</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted" id="time-ai">-</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item step-item" id="step-dependencies">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-circle text-muted me-3"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">Dependency Check</div>
                                    <small class="text-muted">Scanning for vulnerable packages and libraries</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted" id="time-dependencies">-</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item step-item" id="step-reporting">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-circle text-muted me-3"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">Generate Report</div>
                                    <small class="text-muted">Compiling results and security recommendations</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted" id="time-reporting">-</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const scanId = '{{ scan_id }}';
        let startTime = Date.now();
        let progressInterval;
        let errorCount = 0;
        const maxErrors = 5;

        // Step mapping
        const stepMapping = {
            'initializing': 'step-initializing',
            'scanner_init': 'step-initializing',
            'collecting': 'step-collecting',
            'file_collection': 'step-collecting',
            'static_analysis': 'step-static',
            'ai_analysis': 'step-ai',
            'dependency_check': 'step-dependencies',
            'generating_report': 'step-reporting',
            'complete': 'step-reporting'
        };

        function updateProgress() {
            fetch(`/api/scan/progress/${scanId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Progress update:', data);
                    errorCount = 0; // Reset error count on successful fetch
                    
                    if (data.step === 'error') {
                        showError(data.details?.error || 'Unknown error occurred during analysis');
                        return;
                    }
                    
                    if (data.step === 'not_found') {
                        showError('Scan not found or expired. Please try starting a new scan.');
                        return;
                    }
                    
                    // Update progress bar
                    const progressBar = document.getElementById('main-progress-bar');
                    const progressPercentage = document.getElementById('progress-percentage');
                    if (progressBar && progressPercentage) {
                        progressBar.style.width = data.progress + '%';
                        progressPercentage.textContent = data.progress + '%';
                    }
                    
                    // Update current activity
                    const currentActivity = document.getElementById('current-activity');
                    if (currentActivity) {
                        currentActivity.textContent = getActivityMessage(data.step, data.details);
                    }
                    
                    // Update statistics
                    updateStatistics(data.details);
                    
                    // Update step indicators
                    updateStepIndicators(data.step);
                    
                    // Check if complete
                    if (data.step === 'complete') {
                        setTimeout(() => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else {
                                // Fallback if redirect_url is not provided
                                window.location.href = `/results/${scanId}`;
                            }
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching progress:', error);
                    errorCount++;
                    
                    if (errorCount >= maxErrors) {
                        showError(`Connection failed after ${maxErrors} attempts. The analysis may still be running in the background. Please check the results page manually or try refreshing.`);
                    } else {
                        console.log(`Retry ${errorCount}/${maxErrors} in 3 seconds...`);
                        // Don't immediately retry, wait for next interval
                    }
                });
        }

        function getActivityMessage(step, details) {
            const messages = {
                'initializing': 'Initializing BeraMind security scanner...',
                'scanner_init': 'Setting up analysis engine...',
                'collecting': 'Scanning directory for code files...',
                'file_collection': `Found ${details?.files_found || 0} files to analyze...`,
                'static_analysis': 'Running static analysis rules...',
                'ai_analysis': `AI analyzing ${details?.current_file || 'code'} (${details?.files_analyzed || 0}/${details?.total_files || 0})...`,
                'dependency_check': 'Checking dependencies for known vulnerabilities...',
                'generating_report': 'Generating comprehensive security report...',
                'complete': 'Analysis complete! Redirecting to results...'
            };
            
            return messages[step] || 'Processing analysis...';
        }

        function updateStatistics(details) {
            if (details?.files_found !== undefined) {
                const elem = document.getElementById('stat-files');
                if (elem) elem.textContent = details.files_found;
            }
            if (details?.files_analyzed !== undefined) {
                const elem = document.getElementById('stat-analyzed');
                if (elem) elem.textContent = details.files_analyzed;
            }
            if (details?.vulnerabilities_found !== undefined) {
                const elem = document.getElementById('stat-vulns');
                if (elem) elem.textContent = details.vulnerabilities_found;
            }
            
            // Update elapsed time
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const timeElem = document.getElementById('stat-time');
            if (timeElem) timeElem.textContent = elapsed + 's';
        }

        function updateStepIndicators(currentStep) {
            // Reset all steps
            document.querySelectorAll('.step-item').forEach(item => {
                item.classList.remove('active', 'completed');
                const icon = item.querySelector('i');
                if (icon) icon.className = 'fas fa-circle text-muted me-3';
            });
            
            // Get current step element
            const stepElement = document.getElementById(stepMapping[currentStep]);
            
            if (stepElement) {
                // Mark current step as active
                stepElement.classList.add('active');
                const icon = stepElement.querySelector('i');
                if (icon) icon.className = 'fas fa-spinner fa-spin text-primary me-3';
                
                // Mark previous steps as completed
                const allSteps = ['step-initializing', 'step-collecting', 'step-static', 'step-ai', 'step-dependencies', 'step-reporting'];
                const currentIndex = allSteps.indexOf(stepMapping[currentStep]);
                
                for (let i = 0; i < currentIndex; i++) {
                    const prevStep = document.getElementById(allSteps[i]);
                    if (prevStep) {
                        prevStep.classList.remove('active');
                        prevStep.classList.add('completed');
                        const prevIcon = prevStep.querySelector('i');
                        if (prevIcon) prevIcon.className = 'fas fa-check-circle text-success me-3';
                    }
                }
                
                // If complete, mark final step as completed
                if (currentStep === 'complete') {
                    stepElement.classList.remove('active');
                    stepElement.classList.add('completed');
                    const icon = stepElement.querySelector('i');
                    if (icon) icon.className = 'fas fa-check-circle text-success me-3';
                }
            }
        }

        function showError(errorMessage) {
            // Hide progress elements
            const spinner = document.querySelector('.spinner-border');
            if (spinner) spinner.style.display = 'none';
            
            const activity = document.getElementById('current-activity');
            if (activity) activity.textContent = 'Analysis failed';
            
            // Show error card
            const errorCard = document.getElementById('error-card');
            const errorMessageElem = document.getElementById('error-message');
            if (errorCard && errorMessageElem) {
                errorCard.classList.remove('d-none');
                errorMessageElem.textContent = errorMessage;
            }
            
            // Stop progress updates
            if (progressInterval) {
                clearInterval(progressInterval);
            }
        }

        // Start progress updates with error handling
        function startProgressTracking() {
            progressInterval = setInterval(() => {
                if (errorCount < maxErrors) {
                    updateProgress();
                }
            }, 2000);
            
            // Initial update
            updateProgress();
        }

        // Start tracking when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startProgressTracking();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
        });
    </script>
</body>
</html>
